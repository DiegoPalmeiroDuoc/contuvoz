<!DOCTYPE html>
<html lang="es">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#34d399">

  <meta charset="UTF-8" />
  <title>ðŸ¤Ÿ Practica tu letra</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>
  <style>
    /* body { font-family: 'Comic Sans MS', cursive, sans-serif; } */
    #videoWrapper {
      position: relative;
      width: 100%;
      max-width: 90vw;
      aspect-ratio: 4/3;
      margin: auto;
    }
    #outputCanvas, #videoElement {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      border-radius: 1rem;
      object-fit: cover;
    }
    .overlay-text {
      position: absolute;
      background: rgba(255, 255, 255, 0.7);
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-weight: bold;
    }
    #letraDetectada { top: 0.5rem; left: 0.5rem; color: #6b21a8; }
    #conteoEstado { bottom: 0.5rem; right: 0.5rem; color: #166534; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-green-100 via-green-200 to-green-100 flex items-center justify-center p-6 md:p-10 text-center relative">
  <section class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl w-full max-w-2xl border-4 border-green-300 relative">
    <h1 class="text-4xl font-bold text-green-700 mb-4">ðŸ¤Ÿ Practica tu letra</h1>
    <p class="text-lg text-gray-700 mb-2">Haz la letra que se indica y mantenla por 3 segundos.</p>

    <div id="videoWrapper" class="mb-6 shadow-lg border-4 border-green-400 rounded-xl overflow-hidden relative">
      <video id="videoElement" autoplay playsinline muted></video>
      <canvas id="outputCanvas"></canvas>
      <div id="letraDetectada" class="overlay-text absolute"></div>
      <div id="conteoEstado" class="overlay-text absolute"></div>
    </div>

    <a href="../menu.html"
      class="bg-yellow-400 hover:bg-yellow-500 text-white text-xl font-bold px-6 py-3 rounded-xl shadow inline-block">
      â¬… Volver
    </a>
  </section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const videoElement = document.getElementById('videoElement');
  const canvasElement = document.getElementById('outputCanvas');
  const canvasCtx = canvasElement.getContext('2d');
  const letraDiv = document.getElementById('letraDetectada');
  const conteoDiv = document.getElementById('conteoEstado');

  const letrasEstaticas = ['A','B','C','D','E','F','G','H','I','K','L','M','N','O','R','S','T','U','V','W','X','Y'];

  let letraObjetivo = elegirLetraAleatoria();
  let letraDetectada = '';
  let contador = 3;
  let detectando = false;
  let temporizador = null;
  let prevLandmarks = [];

  const hands = new Hands({
    locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
  });
  hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.9,
    minTrackingConfidence: 0.9
  });

  hands.onResults(results => {
    canvasCtx.save();
    canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
    canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
      let landmarks = suavizarLandmarks(results.multiHandLandmarks[0]);
      drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, { color: '#10B981', lineWidth: 4 });
      drawLandmarks(canvasCtx, landmarks, { color: '#1E3A8A', lineWidth: 2 });

      letraDetectada = detectarLetra(landmarks);
      letraDiv.textContent = `Letra detectada: ${letraDetectada || '...'}`;

      if (letraDetectada === letraObjetivo) {
        if (!detectando) iniciarConteo();
      } else {
        reiniciarConteo();
      }
    } else {
      letraDetectada = '';
      letraDiv.textContent = `Letra detectada: ...`;
      reiniciarConteo();
    }

    actualizarTexto();
    canvasCtx.restore();
  });

  const camera = new Camera(videoElement, {
    onFrame: async () => await hands.send({ image: videoElement }),
    width: 640,
    height: 480
  });
  camera.start();

  videoElement.addEventListener('loadeddata', () => {
    canvasElement.width = videoElement.videoWidth;
    canvasElement.height = videoElement.videoHeight;
  });

  function actualizarTexto() {
    if (detectando) {
      conteoDiv.innerHTML = `âœ… Â¡MantÃ©n <span class="text-green-700">${letraObjetivo}</span>! ${contador}`;
    } else if (contador === 0) {
      conteoDiv.innerHTML = `<span class="text-green-700 font-extrabold">âœ… Â¡Muy bien!</span>`;
    } else {
      conteoDiv.innerHTML = `Haz la letra <span class="text-green-700 font-extrabold">${letraObjetivo}</span>`;
    }
  }

  function iniciarConteo() {
    detectando = true;
    contador = 3;
    temporizador = setInterval(() => {
      contador--;
      if (contador > 0) {
        actualizarTexto();
      } else {
        clearInterval(temporizador);
        detectando = false;
        contador = 0;
        actualizarTexto();
        setTimeout(() => {
          letraObjetivo = elegirLetraAleatoria();
          reiniciarConteo();
        }, 1500);
      }
    }, 1000);
  }

  function reiniciarConteo() {
    if (temporizador) clearInterval(temporizador);
    detectando = false;
    contador = 3;
  }

  function elegirLetraAleatoria() {
    return letrasEstaticas[Math.floor(Math.random() * letrasEstaticas.length)];
  }

  function suavizarLandmarks(newLandmarks) {
    if (!prevLandmarks.length) {
      prevLandmarks = JSON.parse(JSON.stringify(newLandmarks));
      return newLandmarks;
    }
    const smoothed = newLandmarks.map((p, i) => ({
      x: (p.x + prevLandmarks[i].x) / 2,
      y: (p.y + prevLandmarks[i].y) / 2,
      z: (p.z + prevLandmarks[i].z) / 2
    }));
    prevLandmarks = smoothed;
    return smoothed;
  }

  function detectarLetra(landmarks) {
  const estirado = (tip, pip) => landmarks[tip].y < landmarks[pip].y - 0.04;
  const pulgarExtendido = Math.abs(landmarks[4].x - landmarks[2].x) > 0.07;

  const indice = estirado(8,6);
  const medio = estirado(12,10);
  const anular = estirado(16,14);
  const menique = estirado(20,18);

  const distIndiceMedio = Math.abs(landmarks[8].x - landmarks[12].x);
  const distIndicePulgar = Math.abs(landmarks[8].x - landmarks[4].x);

  // === LETRAS ===
  if (!pulgarExtendido && !indice && !medio && !anular && !menique)
    return 'A';

  if (!pulgarExtendido && indice && medio && anular && menique)
    return 'B';

  if (pulgarExtendido && indice && medio && anular && menique && distIndicePulgar < 0.06)
    return 'C';

  if (!pulgarExtendido && indice && !medio && !anular && !menique)
    return 'D';

  if (pulgarExtendido && !indice && !medio && !anular && !menique)
    return 'E';

  if (pulgarExtendido && indice && medio && !anular && !menique && distIndiceMedio > 0.03)
    return 'F';

  if (pulgarExtendido && indice && !medio && !anular && !menique)
    return 'G';

  if (!pulgarExtendido && indice && medio && !anular && !menique) {
    if (distIndiceMedio < 0.015) return 'R';  // cruzados
    else return 'H';                          // paralelos
  }

  if (!pulgarExtendido && !indice && !medio && !anular && menique)
    return 'I';

  if (pulgarExtendido && indice && medio && !anular && !menique && distIndiceMedio > 0.04)
    return 'K';

  if (pulgarExtendido && indice && !medio && !anular && !menique)
    return 'L';

  if (pulgarExtendido && !indice && !medio && !anular && menique)
    return 'M';

  if (pulgarExtendido && !indice && !medio && anular && menique)
    return 'N';

  if (pulgarExtendido && indice && medio && anular && menique && distIndicePulgar > 0.06)
    return 'O';

  if (pulgarExtendido && indice && medio && !anular && !menique && distIndiceMedio > 0.06)
    return 'P';

  if (pulgarExtendido && indice && !medio && !anular && !menique && distIndicePulgar > 0.07)
    return 'Q';

  if (pulgarExtendido && !indice && !medio && !anular && !menique)
    return 'S';

  if (!pulgarExtendido && !indice && !medio && !anular && !menique)
    return 'T';

  if (!pulgarExtendido && indice && medio && !anular && !menique) {
    if (distIndiceMedio < 0.035) return 'U';
    else return 'V';
  }

  if (!pulgarExtendido && indice && medio && anular && !menique)
    return 'W';

  if (!pulgarExtendido && indice && !medio && !anular && !menique)
    return 'X';

  if (pulgarExtendido && !indice && !medio && !anular && menique)
    return 'Y';

  return '';
}

});
</script>
</body>
</html>
